#!/bin/bash
# Ð˜Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚ ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚Ð¾Ð² Ð´Ð»Ñ Steam Deck / Linux

OUTPUT_FILE="${1:-screenshot.png}"
WINDOW_TITLE="${2:-Disco Elysium}"

echo "ðŸ” ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ð¿Ð¾Ð¸ÑÐº Ð¾ÐºÐ½Ð°: '$WINDOW_TITLE'"

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð¸ÑÐºÐ° Ð¾ÐºÐ½Ð° Ð¸Ð³Ñ€Ñ‹
find_game_window() {
    if ! command -v xdotool &> /dev/null; then
        echo "âŒ xdotool Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
        return 1
    fi
    
    # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð²ÑÐµ Ð¾ÐºÐ½Ð° Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸
    echo "ðŸ“‹ Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð²ÑÐµÑ… Ð¾ÐºÐ¾Ð½:"
    xdotool search --name "." 2>/dev/null | head -10 | while read -r wid; do
        name=$(xdotool getwindowname "$wid" 2>/dev/null || echo "unknown")
        echo "  ID: $wid, Name: '$name'"
    done
    
    # Ð˜Ñ‰ÐµÐ¼ Ð¾ÐºÐ½Ð¾ Ð¿Ð¾ Ñ‚Ð¾Ñ‡Ð½Ð¾Ð¼Ñƒ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÑŽ
    echo "ðŸ” ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾ Ñ‚Ð¾Ñ‡Ð½Ð¾Ð¼Ñƒ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÑŽ '$WINDOW_TITLE'..."
    WINDOW_ID=$(xdotool search --name "$WINDOW_TITLE" 2>/dev/null | head -1)
    if [ -n "$WINDOW_ID" ]; then
        echo "âœ… ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ð¿Ð¾ Ñ‚Ð¾Ñ‡Ð½Ð¾Ð¼Ñƒ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÑŽ: $WINDOW_ID"
        echo "$WINDOW_ID"
        return 0
    fi
    
    # ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð¿Ð¾Ð¸ÑÐº Ð¿Ð¾ Ñ‡Ð°ÑÑ‚Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ  
    echo "ðŸ” ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾ Ñ‡Ð°ÑÑ‚Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ 'Disco'..."
    WINDOW_ID=$(xdotool search --name "Disco" 2>/dev/null | head -1)
    if [ -n "$WINDOW_ID" ]; then
        echo "âœ… ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ð¿Ð¾ Ñ‡Ð°ÑÑ‚Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ: $WINDOW_ID"
        echo "$WINDOW_ID"
        return 0
    fi
    
    echo "âŒ ÐžÐºÐ½Ð¾ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾"
    return 1
}

# Steam Deck Desktop Mode - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Spectacle
if command -v spectacle &> /dev/null; then
    # ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ð¾ÐºÐ½Ð°
    echo "ðŸ” Ð˜Ñ‰ÐµÐ¼ Ð¾ÐºÐ½Ð¾: '$WINDOW_TITLE'"
    WINDOW_ID=$(find_game_window)
    if [ -n "$WINDOW_ID" ]; then
        echo "ðŸŽ® Ð¡ÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚ Ð¾ÐºÐ½Ð° Ð¸Ð³Ñ€Ñ‹ (ID: $WINDOW_ID)"
        # ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ Ð¾ÐºÐ½Ð¾ Ð¸ Ð´ÐµÐ»Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚
        xdotool windowactivate "$WINDOW_ID" 2>/dev/null || true
        sleep 0.2
        spectacle --activewindow --nonotify --background --output "$OUTPUT_FILE"
    else
        echo "ðŸ–¥ï¸  Ð¡ÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚ Ð²ÑÐµÐ³Ð¾ ÑÐºÑ€Ð°Ð½Ð° (Ð¾ÐºÐ½Ð¾ Ð¸Ð³Ñ€Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾)"
        # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð¾ÐºÐ½Ð° Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸
        echo "ðŸ“‹ Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð¾ÐºÐ½Ð°:"
        xdotool search --name "." 2>/dev/null | while read -r wid; do
            name=$(xdotool getwindowname "$wid" 2>/dev/null || echo "unknown")
            echo "  ID: $wid, Name: $name"
        done | head -5
        spectacle --fullscreen --nonotify --background --output "$OUTPUT_FILE"
    fi
    exit $?
fi

# Fallback Ð´Ð»Ñ Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²
if command -v scrot &> /dev/null; then
    scrot "$OUTPUT_FILE"
    exit $?
fi

if command -v grim &> /dev/null; then
    grim "$OUTPUT_FILE"  
    exit $?
fi

echo "âŒ ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚ Ð´Ð»Ñ ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚Ð¾Ð²" >&2
echo "ðŸ’¡ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ: sudo pacman -S spectacle" >&2
exit 1