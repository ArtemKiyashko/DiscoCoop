#!/bin/bash
# Ð˜Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚ ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚Ð¾Ð² Ð´Ð»Ñ Steam Deck / Linux

OUTPUT_FILE="${1:-screenshot.png}"
WINDOW_TITLE="${2:-Disco Elysium}"

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð¸ÑÐºÐ° Ð¾ÐºÐ½Ð° Ð¸Ð³Ñ€Ñ‹
find_game_window() {
    if command -v xdotool &> /dev/null; then
        # Ð˜Ñ‰ÐµÐ¼ Ð¾ÐºÐ½Ð¾ Ð¿Ð¾ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÑŽ
        WINDOW_ID=$(xdotool search --name "$WINDOW_TITLE" | head -1)
        if [ -n "$WINDOW_ID" ]; then
            echo "$WINDOW_ID"
            return 0
        fi
    fi
    return 1
}

# Steam Deck Desktop Mode - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Spectacle
if command -v spectacle &> /dev/null; then
    # ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ ÑÐ´ÐµÐ»Ð°Ñ‚ÑŒ ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ð¾ÐºÐ½Ð°
    WINDOW_ID=$(find_game_window)
    if [ -n "$WINDOW_ID" ]; then
        echo "ðŸŽ® Ð¡ÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚ Ð¾ÐºÐ½Ð° Ð¸Ð³Ñ€Ñ‹ (ID: $WINDOW_ID)"
        spectacle -w -n -b -o "$OUTPUT_FILE"
    else
        echo "ðŸ–¥ï¸  Ð¡ÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚ Ð²ÑÐµÐ³Ð¾ ÑÐºÑ€Ð°Ð½Ð° (Ð¾ÐºÐ½Ð¾ Ð¸Ð³Ñ€Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾)"
        spectacle -f -b -o "$OUTPUT_FILE"
    fi
    exit $?
fi

# Fallback Ð´Ð»Ñ Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²
if command -v scrot &> /dev/null; then
    scrot "$OUTPUT_FILE"
    exit $?
fi

if command -v grim &> /dev/null; then
    grim "$OUTPUT_FILE"  
    exit $?
fi

echo "âŒ ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚ Ð´Ð»Ñ ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚Ð¾Ð²" >&2
echo "ðŸ’¡ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ: sudo pacman -S spectacle" >&2
exit 1