#!/bin/bash
# Ð˜Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚ ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚Ð¾Ð² Ð´Ð»Ñ Steam Deck / Linux

OUTPUT_FILE="${1:-screenshot.png}"
WINDOW_TITLE="${2:-Disco Elysium}"

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð¸ÑÐºÐ° Ð¾ÐºÐ½Ð° Ð¸Ð³Ñ€Ñ‹
find_game_window() {
    if ! command -v xdotool &> /dev/null; then
        return 1
    fi
    
    # Ð˜Ñ‰ÐµÐ¼ Ð¾ÐºÐ½Ð¾ Ð¿Ð¾ Ñ‚Ð¾Ñ‡Ð½Ð¾Ð¼Ñƒ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÑŽ
    WINDOW_ID=$(xdotool search --name "$WINDOW_TITLE" 2>/dev/null | head -1)
    if [ -n "$WINDOW_ID" ]; then
        echo "$WINDOW_ID"
        return 0
    fi
    
    # ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð¿Ð¾Ð¸ÑÐº Ð¿Ð¾ Ñ‡Ð°ÑÑ‚Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ  
    WINDOW_ID=$(xdotool search --name "Disco" 2>/dev/null | head -1)
    if [ -n "$WINDOW_ID" ]; then
        echo "$WINDOW_ID"
        return 0
    fi
    
    return 1
}

# Steam Deck Desktop Mode - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Spectacle
if command -v spectacle &> /dev/null; then
    # Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¸Ñ‰ÐµÐ¼ Ð¾ÐºÐ½Ð¾ Ð¸Ð³Ñ€Ñ‹
    WINDOW_ID=$(find_game_window)
    
    if [ -n "$WINDOW_ID" ]; then
        echo "ðŸŽ® Ð¡ÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚ Ð¾ÐºÐ½Ð° Ð¸Ð³Ñ€Ñ‹ (ID: $WINDOW_ID)"
        # ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ Ð¾ÐºÐ½Ð¾ Ð¸ Ð´ÐµÐ»Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚
        xdotool windowactivate "$WINDOW_ID" 2>/dev/null || true
        sleep 0.2
        # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ activewindow (-a) 
        spectacle -a -n -b -o "$OUTPUT_FILE"
    else
        echo "ðŸ–¥ï¸  Ð¡ÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚ Ð²ÑÐµÐ³Ð¾ ÑÐºÑ€Ð°Ð½Ð° (Ð¾ÐºÐ½Ð¾ Ð¸Ð³Ñ€Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾)"
        spectacle -f -n -b -o "$OUTPUT_FILE"
    fi
    exit $?
fi

# Fallback Ð´Ð»Ñ Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²
if command -v scrot &> /dev/null; then
    scrot "$OUTPUT_FILE"
    exit $?
fi

if command -v grim &> /dev/null; then
    grim "$OUTPUT_FILE"  
    exit $?
fi

echo "âŒ ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚ Ð´Ð»Ñ ÑÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚Ð¾Ð²" >&2
echo "ðŸ’¡ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ: sudo pacman -S spectacle" >&2
exit 1