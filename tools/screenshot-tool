#!/bin/bash
# Инструмент скриншотов для Steam Deck / Linux

OUTPUT_FILE="${1:-screenshot.png}"
WINDOW_TITLE="${2:-Disco Elysium}"

# Функция для поиска окна игры
find_game_window() {
    if ! command -v xdotool &> /dev/null; then
        return 1
    fi
    
    # Ищем окно по точному названию
    WINDOW_ID=$(xdotool search --name "$WINDOW_TITLE" 2>/dev/null | head -1)
    if [ -n "$WINDOW_ID" ]; then
        echo "$WINDOW_ID"
        return 0
    fi
    
    # Попробуем поиск по части названия  
    WINDOW_ID=$(xdotool search --name "Disco" 2>/dev/null | head -1)
    if [ -n "$WINDOW_ID" ]; then
        echo "$WINDOW_ID"
        return 0
    fi
    
    return 1
}

# Steam Deck Desktop Mode - используем Spectacle
if command -v spectacle &> /dev/null; then
    # Сначала ищем окно игры
    WINDOW_ID=$(find_game_window)
    
    if [ -n "$WINDOW_ID" ]; then
        echo "🎮 Скриншот окна игры (ID: $WINDOW_ID)"
        # Активируем окно и делаем скриншот
        xdotool windowactivate "$WINDOW_ID" 2>/dev/null || true
        sleep 0.3
        # Используем windowUnderCursor после активации окна
        spectacle --windowUnderCursor --nonotify --background --output "$OUTPUT_FILE" &
        SPECTACLE_PID=$!
        # Кликаем на окно чтобы spectacle его захватил
        sleep 0.1
        xdotool windowfocus "$WINDOW_ID" 2>/dev/null || true
        wait $SPECTACLE_PID
    else
        echo "🖥️  Скриншот всего экрана (окно игры не найдено)"
        spectacle --fullscreen --nonotify --background --output "$OUTPUT_FILE"
    fi
    exit $?
fi

# Fallback для других инструментов
if command -v scrot &> /dev/null; then
    scrot "$OUTPUT_FILE"
    exit $?
fi

if command -v grim &> /dev/null; then
    grim "$OUTPUT_FILE"  
    exit $?
fi

echo "❌ Не найден инструмент для скриншотов" >&2
echo "💡 Установите: sudo pacman -S spectacle" >&2
exit 1