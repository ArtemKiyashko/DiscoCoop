#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Ollama –Ω–∞ Steam Deck
# –†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ /usr/local

set -e

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Ollama –Ω–∞ Steam Deck..."

# –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
mkdir -p "$HOME/.local/bin"
mkdir -p "$HOME/.ollama"

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
ARCH=$(uname -m)
if [ "$ARCH" = "x86_64" ]; then
    OLLAMA_URL="https://github.com/ollama/ollama/releases/latest/download/ollama-linux-amd64"
else
    echo "‚ùå –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: $ARCH"
    exit 1
fi

# –°–∫–∞—á–∏–≤–∞–µ–º Ollama –Ω–∞–ø—Ä—è–º—É—é
echo "üì• –ó–∞–≥—Ä—É–∑–∫–∞ Ollama..."
if curl -L "$OLLAMA_URL" -o "$HOME/.local/bin/ollama"; then
    chmod +x "$HOME/.local/bin/ollama"
    echo "‚úÖ Ollama —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ $HOME/.local/bin/ollama"
else
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å Ollama"
    exit 1
fi

# –û–±–Ω–æ–≤–ª—è–µ–º PATH
export PATH="$HOME/.local/bin:$PATH"

# –î–æ–±–∞–≤–ª—è–µ–º –≤ bashrc –µ—Å–ª–∏ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ
if ! grep -q "export PATH.*\.local/bin" ~/.bashrc; then
    echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
    echo "‚úÖ PATH –æ–±–Ω–æ–≤–ª–µ–Ω –≤ ~/.bashrc"
fi

# –°–æ–∑–¥–∞–µ–º —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é —Å—Å—ã–ª–∫—É –≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
if [ ! -f "./ollama" ]; then
    ln -s "$HOME/.local/bin/ollama" ./ollama
    echo "‚úÖ –°–æ–∑–¥–∞–Ω–∞ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ ./ollama"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É
if "$HOME/.local/bin/ollama" --version; then
    echo "‚úÖ Ollama —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    echo "üöÄ –î–ª—è –∑–∞–ø—É—Å–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: $HOME/.local/bin/ollama serve"
    echo "üìÅ –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ: ./ollama serve (–≤ —ç—Ç–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏)"
else
    echo "‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π Ollama"
    exit 1
fi

echo "üéâ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"